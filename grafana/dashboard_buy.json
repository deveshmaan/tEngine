{
  "title": "Intraday BUY Engine — v2",
  "uid": "buy-engine-v2",
  "timezone": "browser",
  "editable": true,
  "schemaVersion": 38,
  "version": 1,
  "refresh": "2s",
  "panels": [
    { "type": "stat", "title": "Engine Up", "gridPos": {"x":0,"y":0,"w":4,"h":3},
      "datasource": {"type":"prometheus","uid":"prometheus"},
      "targets": [{"expr":"engine_up","refId":"A"}],
      "options":{"reduceOptions":{"calcs":["lastNotNull"]},"colorMode":"background"}
    },
    { "type": "stat", "title": "Heartbeat Lag (s)", "gridPos": {"x":4,"y":0,"w":4,"h":3},
      "datasource": {"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"s","thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"yellow","value":1.5},{"color":"red","value":3}]}}},
      "targets": [{"expr":"time() - heartbeat_ts","refId":"A"}]
    },
    { "type": "stat", "title": "Session", "gridPos": {"x":8,"y":0,"w":4,"h":3},
      "datasource": {"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"mappings":[{"type":"value","options":{"0":{"text":"PREOPEN"},"1":{"text":"LIVE"},"2":{"text":"HALT"},"3":{"text":"POST_CLOSE"}}}]}},
      "targets": [{"expr":"session_state","refId":"A"}]
    },
    { "type": "stat", "title": "PnL (₹)", "gridPos": {"x":12,"y":0,"w":4,"h":3},
      "datasource": {"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"currencyINR"}},
      "targets": [{"expr":"pnl_net_rupees","refId":"A"}]
    },
    { "type": "stat", "title": "PnL vs Stop (₹)", "gridPos": {"x":16,"y":0,"w":8,"h":3},
      "datasource": {"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"currencyINR"}},
      "targets": [{"expr":"pnl_net_rupees - risk_daily_stop_rupees","refId":"A"}]
    },

    { "type":"stat", "title":"Subscribed (count)", "gridPos":{"x":0,"y":3,"w":4,"h":3},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"sum(md_subscription_info)","refId":"A"}]
    },
    { "type":"timeseries","title":"WS lag & Reconnects","gridPos":{"x":4,"y":3,"w":10,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"ms"}},
      "targets":[
        {"expr":"ws_lag_ms","legendFormat":"ws_lag_ms","refId":"A"},
        {"expr":"increase(ws_reconnects_total[15m])","legendFormat":"reconnects(15m)","refId":"B"}
      ]
    },
    { "type":"bargauge","title":"API errors (15m)","gridPos":{"x":14,"y":3,"w":10,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"sum by (code) (increase(api_errors_total[15m]))","refId":"A"}]
    },
    { "type":"stat","title":"Strategy Lag (s)","gridPos":{"x":0,"y":9,"w":4,"h":3},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"s","decimals":1,"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"yellow","value":2},{"color":"red","value":5}]}}},
      "targets":[{"expr":"time() - strategy_last_eval_ts","refId":"A"}]
    },
    { "type":"stat","title":"Strategy evals / min","gridPos":{"x":4,"y":9,"w":4,"h":3},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"ops","decimals":0,"thresholds":{"mode":"absolute","steps":[{"color":"red","value":0},{"color":"green","value":1}]}}},
      "targets":[{"expr":"sum(rate(strategy_evals_total[5m])) * 60","refId":"A"}]
    },

    { "type":"table","title":"Tick Freshness & Spread","gridPos":{"x":0,"y":12,"w":24,"h":8},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "options":{"showHeader":true},
      "targets":[
        {"expr":"time() - option_last_ts_seconds","legendFormat":"{{instrument_key}} age","instant":true,"refId":"AGE","format":"table"},
        {"expr":"(option_ask - option_bid) / clamp_min(option_ltp, 0.01) * 100","legendFormat":"{{instrument_key}} spread%","instant":true,"refId":"SP","format":"table"}
      ]
    },

    { "type":"timeseries","title":"Spread (ticks)","gridPos":{"x":0,"y":20,"w":12,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"option_spread_ticks","legendFormat":"{{instrument_key}}","refId":"A"}]
    },
    { "type":"timeseries","title":"OB Imbalance (Top10)","gridPos":{"x":12,"y":20,"w":12,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"orderbook_imbalance_10","legendFormat":"{{instrument_key}}","refId":"A"}]
    },

    { "type":"timeseries","title":"Orders vs Fills","gridPos":{"x":0,"y":26,"w":12,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[
        {"expr":"sum(rate(orders_submitted_total[5m]))","legendFormat":"submitted","refId":"A"},
        {"expr":"sum(rate(orders_filled_total[5m]))","legendFormat":"filled","refId":"B"}
      ]
    },
    { "type":"timeseries","title":"Rejected Orders (by reason)","gridPos":{"x":12,"y":26,"w":12,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"sum(rate(orders_rejected_total[5m])) by (reason)","legendFormat":"{{reason}}","refId":"A"}]
    },

    { "type":"timeseries","title":"Order Latency p50/p95/p99 (ms)","gridPos":{"x":0,"y":32,"w":12,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"ms"}},
      "targets":[
        {"expr":"histogram_quantile(0.50, sum(rate(order_latency_ms_bucketed_bucket[5m])) by (le))","refId":"P50","legendFormat":"p50"},
        {"expr":"histogram_quantile(0.95, sum(rate(order_latency_ms_bucketed_bucket[5m])) by (le))","refId":"P95","legendFormat":"p95"},
        {"expr":"histogram_quantile(0.99, sum(rate(order_latency_ms_bucketed_bucket[5m])) by (le))","refId":"P99","legendFormat":"p99"}
      ]
    },
    { "type":"timeseries","title":"Queues","gridPos":{"x":12,"y":32,"w":12,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[
        {"expr":"event_queue_depth","legendFormat":"event","refId":"A"},
        {"expr":"order_queue_depth","legendFormat":"order","refId":"B"},
        {"expr":"broker_queue_depth","legendFormat":"broker","refId":"C"}
      ]
    },

    { "type":"table","title":"IV / OI (snapshot)","gridPos":{"x":0,"y":38,"w":12,"h":8},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[
        {"expr":"option_iv","legendFormat":"{{instrument_key}} IV","instant":true,"refId":"IV","format":"table"},
        {"expr":"option_oi","legendFormat":"{{instrument_key}} OI","instant":true,"refId":"OI","format":"table"}
      ]
    },
    { "type":"table","title":"Expiry Discovery & Guardrails","gridPos":{"x":12,"y":38,"w":12,"h":8},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[
        {"expr":"expiry_source","legendFormat":"source","instant":true,"refId":"SRC","format":"table"},
        {"expr":"increase(expiry_discovery_attempt_total[1h])","legendFormat":"attempts(1h)","instant":true,"refId":"E1","format":"table"},
        {"expr":"increase(expiry_discovery_success_total[1h])","legendFormat":"success(1h)","instant":true,"refId":"E2","format":"table"},
        {"expr":"sum(increase(api_errors_total{code=\"UDAPI1088\"}[1h]))","legendFormat":"UDAPI1088(1h)","instant":true,"refId":"E3","format":"table"}
      ]
    },

    { "type":"stat","title":"Open Lots","gridPos":{"x":0,"y":46,"w":4,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"risk_open_lots","refId":"A"}]
    },
    { "type":"stat","title":"Notional Premium (₹)","gridPos":{"x":4,"y":46,"w":8,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"currencyINR"}},
      "targets":[{"expr":"risk_notional_premium_rupees","refId":"A"}]
    },
    { "type":"stat","title":"Minutes to Square-off","gridPos":{"x":12,"y":46,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"minutes_to_square_off","refId":"A"}]
    },
    { "type":"bargauge","title":"Rate-limit tokens (min by endpoint)","gridPos":{"x":18,"y":46,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"min by (endpoint) (ratelimit_tokens)","refId":"A"}]
    },
    { "type":"timeseries","title":"Strategy evals (5m)","gridPos":{"x":18,"y":50,"w":6,"h":5},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"ops","decimals":0}},
      "targets":[{"expr":"increase(strategy_evals_total[5m])","legendFormat":"evals_5m","refId":"A"}]
    },

    { "type":"stat","title":"MA crossover (NIFTY)","gridPos":{"x":0,"y":55,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"strategy_ma_crossover_state{symbol=\"NIFTY\"}","refId":"A"}],
      "fieldConfig":{"defaults":{"mappings":[{"type":"value","options":{"0":{"text":"Below"},"1":{"text":"Above"}}}]}}
    },
    { "type":"stat","title":"Vol breakout (NIFTY)","gridPos":{"x":6,"y":55,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"strategy_vol_breakout_state{symbol=\"NIFTY\"}","refId":"A"}],
      "fieldConfig":{"defaults":{"mappings":[{"type":"value","options":{"0":{"text":"Calm"},"1":{"text":"Breakout"}}}]}}
    },
    { "type":"stat","title":"Last position size","gridPos":{"x":12,"y":55,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"max(strategy_position_size)","refId":"A"}]
    },
    { "type":"bargauge","title":"Exit triggers (5m)","gridPos":{"x":18,"y":55,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"sum by (reason) (increase(exit_events_total[5m]))","refId":"A"}]
    },
    { "type":"timeseries","title":"Realized vol vs avg (NIFTY)","gridPos":{"x":0,"y":59,"w":24,"h":6},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"percentunit","decimals":4}},
      "targets":[
        {"expr":"strategy_realized_vol{symbol=\"NIFTY\"}","legendFormat":"realized","refId":"RV"},
        {"expr":"strategy_realized_vol_avg{symbol=\"NIFTY\"}","legendFormat":"avg","refId":"AVG"}
      ]
    },

    { "type":"stat","title":"IMI (NIFTY)","gridPos":{"x":0,"y":65,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"percent","decimals":1,"thresholds":{"mode":"absolute","steps":[{"color":"red","value":0},{"color":"green","value":30},{"color":"yellow","value":70}]}}},
      "targets":[{"expr":"strategy_imi{symbol=\"NIFTY\"}","refId":"A"}]
    },
    { "type":"stat","title":"PCR (NIFTY)","gridPos":{"x":6,"y":65,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"strategy_pcr{symbol=\"NIFTY\"}","refId":"A"}]
    },
    { "type":"stat","title":"IV Percentile (NIFTY)","gridPos":{"x":12,"y":65,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "fieldConfig":{"defaults":{"unit":"percent","decimals":1}},
      "targets":[{"expr":"strategy_iv_percentile{symbol=\"NIFTY\"}","refId":"A"}]
    },
    { "type":"stat","title":"OI Trend (last)","gridPos":{"x":18,"y":65,"w":6,"h":4},
      "datasource":{"type":"prometheus","uid":"prometheus"},
      "targets":[{"expr":"max(strategy_oi_trend)","refId":"A"}],
      "fieldConfig":{"defaults":{"mappings":[{"type":"value","options":{"-1":{"text":"Falling"},"0":{"text":"Neutral"},"1":{"text":"Rising"}}}]}}
    }
  ]
}
